'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { ComplaintStatus, Complaint } from '@/lib/database.types'
import { getStatusColor, getStatusText, getStatusIcon } from '@/lib/helpers'
import AdminSidebar from '@/components/admin/AdminSidebar'

export default function AdminPage() {
  const router = useRouter()
  const [isAdmin, setIsAdmin] = useState<boolean | null>(null) // null = loading, false = not admin, true = admin
  const [complaints, setComplaints] = useState<Complaint[]>([])
  const [loading, setLoading] = useState(true)
  const [statusFilter, setStatusFilter] = useState<string>('all')
  const [categoryFilter, setCategoryFilter] = useState<string>('all')
  const [selectedComplaint, setSelectedComplaint] = useState<Complaint | null>(null)
  const [showEditModal, setShowEditModal] = useState(false)
  const [editStatus, setEditStatus] = useState<ComplaintStatus>('not_reviewed')
  const [editNotes, setEditNotes] = useState('')

  // Check if user is admin on mount
  useEffect(() => {
    checkAdminStatus()
  }, [])

  // Fetch complaints when admin check is done
  useEffect(() => {
    if (isAdmin === true) {
      fetchComplaints()
    }
  }, [isAdmin])

  const checkAdminStatus = async () => {
    const supabase = createClient()

    // Get current user
    const { data: { user }, error: userError } = await supabase.auth.getUser()

    if (userError || !user) {
      setIsAdmin(false)
      return
    }

    // Check if user is in admins table
    const { data: adminData, error: adminError } = await supabase
      .from('admins')
      .select('*')
      .eq('email', user.email)
      .single()

    if (adminError || !adminData) {
      setIsAdmin(false)
    } else {
      setIsAdmin(true)
    }
  }

  const handleLogout = async () => {
    const supabase = createClient()
    await supabase.auth.signOut()
    router.push('/')
  }

  const fetchComplaints = async () => {
    setLoading(true)
    const supabase = createClient()

    const { data, error } = await supabase
      .from('complaints')
      .select('*')
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Error fetching complaints:', error)
    } else {
      setComplaints(data || [])
    }
    setLoading(false)
  }

  const handleEditClick = (complaint: Complaint) => {
    setSelectedComplaint(complaint)
    setEditStatus(complaint.status)
    setEditNotes(complaint.admin_notes || '')
    setShowEditModal(true)
  }

  const handleUpdateComplaint = async () => {
    if (!selectedComplaint) return

    const supabase = createClient()

    const { error } = await supabase
      .from('complaints')
      .update({
        status: editStatus,
        admin_notes: editNotes,
      })
      .eq('id', selectedComplaint.id)

    if (error) {
      console.error('Error updating complaint:', error)
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙˆÙ‰')
    } else {
      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­')
      setShowEditModal(false)
      fetchComplaints()
    }
  }

  const handleExportCSV = () => {
    const filteredData = getFilteredComplaints()

    const headers = ['ÙƒÙˆØ¯ Ø§Ù„ØªØªØ¨Ø¹', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„ÙØ¦Ø©', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„ØªØ§Ø±ÙŠØ®']
    const rows = filteredData.map((c) => [
      c.tracking_code,
      c.full_name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
      c.category,
      getStatusText(c.status),
      new Date(c.created_at).toLocaleDateString('ar-EG'),
    ])

    const csv = [headers, ...rows].map((row) => row.join(',')).join('\n')
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    link.href = URL.createObjectURL(blob)
    link.download = `complaints_${new Date().toISOString().split('T')[0]}.csv`
    link.click()
  }

  const getFilteredComplaints = () => {
    return complaints.filter((complaint) => {
      const statusMatch = statusFilter === 'all' || complaint.status === statusFilter
      const categoryMatch = categoryFilter === 'all' || complaint.category === categoryFilter
      return statusMatch && categoryMatch
    })
  }

  // Loading State
  if (isAdmin === null) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-navy via-navy-light to-navy flex items-center justify-center p-4">
        <div className="text-center">
          <div className="w-20 h-20 bg-white rounded-xl flex items-center justify-center shadow-lg mx-auto mb-6 animate-pulse">
            <span className="text-navy text-4xl font-black">Ù†</span>
          </div>
          <p className="text-white text-lg font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...</p>
        </div>
      </div>
    )
  }

  // Access Denied - Redirect to Login
  if (isAdmin === false) {
    router.push('/admin/login')
    return (
      <div className="min-h-screen bg-gradient-to-br from-navy via-navy-light to-navy flex items-center justify-center p-4">
        <div className="text-center">
          <div className="w-20 h-20 bg-white rounded-xl flex items-center justify-center shadow-lg mx-auto mb-6 animate-pulse">
            <span className="text-navy text-4xl font-black">Ù†</span>
          </div>
          <p className="text-white text-lg font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...</p>
        </div>
      </div>
    )
  }

  // Dashboard
  const filteredComplaints = getFilteredComplaints()

  return (
    <div className="min-h-screen bg-gray-50 flex" dir="rtl">
      {/* Sidebar */}
      <AdminSidebar />

      {/* Main Content */}
      <div className="flex-1 mr-64">
        <div className="container mx-auto px-8 py-8">
        {/* Statistics */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
          <div className="bg-white rounded-2xl p-6 text-center hover:shadow-xl transition border-r-4 border-navy">
            <div className="text-4xl font-black text-navy mb-2">
              {complaints.length}
            </div>
            <div className="text-gray-600 font-bold text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</div>
          </div>

          <div className="bg-white rounded-2xl p-6 text-center hover:shadow-xl transition border-r-4 border-gray-400">
            <div className="text-4xl font-black text-gray-600 mb-2">
              {complaints.filter((c) => c.status === 'not_reviewed').length}
            </div>
            <div className="text-gray-600 font-bold text-sm">Ù„Ù… ØªØªØ±Ø§Ø¬Ø¹</div>
          </div>

          <div className="bg-white rounded-2xl p-6 text-center hover:shadow-xl transition border-r-4 border-blue-400">
            <div className="text-4xl font-black text-blue-600 mb-2">
              {complaints.filter((c) => c.status === 'reviewed').length}
            </div>
            <div className="text-gray-600 font-bold text-sm">Ø§ØªØ±Ø§Ø¬Ø¹Øª</div>
          </div>

          <div className="bg-white rounded-2xl p-6 text-center hover:shadow-xl transition border-r-4 border-yellow-400">
            <div className="text-4xl font-black text-yellow-600 mb-2">
              {complaints.filter((c) => c.status === 'in_progress').length}
            </div>
            <div className="text-gray-600 font-bold text-sm">Ø¨ØªØªÙ†ÙØ°</div>
          </div>

          <div className="bg-white rounded-2xl p-6 text-center hover:shadow-xl transition border-r-4 border-green-400">
            <div className="text-4xl font-black text-green-600 mb-2">
              {complaints.filter((c) => c.status === 'completed').length}
            </div>
            <div className="text-gray-600 font-bold text-sm">ØªÙ…Øª</div>
          </div>
        </div>

        {/* Filters */}
        <div className="bg-white rounded-2xl shadow-md p-6 mb-8">
          <div className="flex flex-col md:flex-row gap-4 items-end">
            <div className="flex-1">
              <label className="block text-sm font-bold text-gray-700 mb-2">
                ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
              </label>
              <select
                value={statusFilter}
                onChange={(e) => setStatusFilter(e.target.value)}
                className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-gold focus:outline-none"
              >
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="not_reviewed">Ù„Ù… ØªØªØ±Ø§Ø¬Ø¹</option>
                <option value="reviewed">Ø§ØªØ±Ø§Ø¬Ø¹Øª</option>
                <option value="in_progress">Ø¨ØªØªÙ†ÙØ°</option>
                <option value="completed">ØªÙ…Øª</option>
              </select>
            </div>

            <div className="flex-1">
              <label className="block text-sm font-bold text-gray-700 mb-2">
                ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
              </label>
              <select
                value={categoryFilter}
                onChange={(e) => setCategoryFilter(e.target.value)}
                className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-gold focus:outline-none"
              >
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
                <option value="health">Ù…Ø´Ø§ÙƒÙ„ ØµØ­ÙŠØ©</option>
                <option value="education">Ù…Ø´Ø§ÙƒÙ„ ØªØ¹Ù„ÙŠÙ…ÙŠØ©</option>
                <option value="infrastructure">Ø¨Ù†ÙŠØ© ØªØ­ØªÙŠØ©</option>
                <option value="social">Ù…Ø´Ø§ÙƒÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</option>
                <option value="economic">Ù…Ø´Ø§ÙƒÙ„ Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</option>
                <option value="public_services">Ø®Ø¯Ù…Ø§Øª Ø¹Ø§Ù…Ø©</option>
              </select>
            </div>

            <button
              onClick={handleExportCSV}
              className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200"
            >
              ğŸ“¥ ØªØµØ¯ÙŠØ± CSV
            </button>
          </div>
        </div>

        {/* Complaints Table */}
        <div className="bg-white rounded-2xl shadow-md overflow-hidden">
          {loading ? (
            <div className="text-center py-12">
              <div className="text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
          ) : filteredComplaints.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-gray-500 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰</div>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-navy text-white">
                  <tr>
                    <th className="px-6 py-4 text-right font-bold">ÙƒÙˆØ¯ Ø§Ù„ØªØªØ¨Ø¹</th>
                    <th className="px-6 py-4 text-right font-bold">Ø§Ù„Ø§Ø³Ù…</th>
                    <th className="px-6 py-4 text-right font-bold">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
                    <th className="px-6 py-4 text-right font-bold">Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th className="px-6 py-4 text-right font-bold">Ø§Ù„ÙØ¦Ø©</th>
                    <th className="px-6 py-4 text-right font-bold">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th className="px-6 py-4 text-right font-bold">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th className="px-6 py-4 text-right font-bold">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredComplaints.map((complaint) => (
                    <tr
                      key={complaint.id}
                      className="border-b border-gray-100 hover:bg-gray-50 transition"
                    >
                      <td className="px-6 py-4 font-mono font-bold text-navy">
                        {complaint.tracking_code}
                      </td>
                      <td className="px-6 py-4 font-bold">{complaint.full_name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</td>
                      <td className="px-6 py-4 font-mono" dir="ltr">
                        {complaint.national_id}
                      </td>
                      <td className="px-6 py-4" dir="ltr">
                        {complaint.phone}
                      </td>
                      <td className="px-6 py-4">
                        <span className="text-sm">
                          {complaint.category === 'health' && 'ğŸ¥ Ù…Ø´Ø§ÙƒÙ„ ØµØ­ÙŠØ©'}
                          {complaint.category === 'education' && 'ğŸ“š Ù…Ø´Ø§ÙƒÙ„ ØªØ¹Ù„ÙŠÙ…ÙŠØ©'}
                          {complaint.category === 'infrastructure' && 'ğŸ—ï¸ Ø¨Ù†ÙŠØ© ØªØ­ØªÙŠØ©'}
                          {complaint.category === 'social' && 'âš–ï¸ Ù…Ø´Ø§ÙƒÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©'}
                          {complaint.category === 'economic' && 'ğŸ’¼ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©'}
                          {complaint.category === 'public_services' && 'ğŸ›ï¸ Ø®Ø¯Ù…Ø§Øª Ø¹Ø§Ù…Ø©'}
                        </span>
                      </td>
                      <td className="px-6 py-4">
                        <span
                          className={`inline-block px-3 py-1 rounded-full text-xs font-bold border ${getStatusColor(
                            complaint.status
                          )}`}
                        >
                          {getStatusIcon(complaint.status)} {getStatusText(complaint.status)}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {new Date(complaint.created_at).toLocaleDateString('ar-EG')}
                      </td>
                      <td className="px-6 py-4">
                        <button
                          onClick={() => handleEditClick(complaint)}
                          className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all duration-200"
                        >
                          ØªØ¹Ø¯ÙŠÙ„
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      {/* Edit Modal */}
      {showEditModal && selectedComplaint && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-navy text-white p-6 rounded-t-2xl">
              <h2 className="text-2xl font-black">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
              <p className="text-gold text-sm mt-1">
                ÙƒÙˆØ¯ Ø§Ù„ØªØªØ¨Ø¹: {selectedComplaint.tracking_code}
              </p>
            </div>

            <div className="p-6 space-y-6">
              {/* Complaint Details */}
              <div className="bg-gray-50 rounded-xl p-4 space-y-2">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <span className="text-sm font-bold text-gray-600">Ø§Ù„Ø§Ø³Ù…:</span>
                    <p className="font-bold">{selectedComplaint.full_name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                  </div>
                  <div>
                    <span className="text-sm font-bold text-gray-600">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</span>
                    <p className="font-bold font-mono" dir="ltr">
                      {selectedComplaint.national_id}
                    </p>
                  </div>
                  <div>
                    <span className="text-sm font-bold text-gray-600">Ø§Ù„Ù‡Ø§ØªÙ:</span>
                    <p className="font-bold" dir="ltr">
                      {selectedComplaint.phone}
                    </p>
                  </div>
                </div>
                <div>
                  <span className="text-sm font-bold text-gray-600">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span>
                  <p className="font-bold">{selectedComplaint.location}</p>
                </div>
                <div>
                  <span className="text-sm font-bold text-gray-600">Ø§Ù„ÙˆØµÙ:</span>
                  <p className="text-gray-700">{selectedComplaint.description}</p>
                </div>
                {selectedComplaint.image_url && (
                  <div>
                    <span className="text-sm font-bold text-gray-600">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©:</span>
                    <img
                      src={selectedComplaint.image_url}
                      alt="ØµÙˆØ±Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰"
                      className="mt-2 rounded-lg max-w-md border border-gray-200"
                    />
                  </div>
                )}
              </div>

              {/* Status Update */}
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">
                  ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                </label>
                <select
                  value={editStatus}
                  onChange={(e) => setEditStatus(e.target.value as ComplaintStatus)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gold focus:outline-none"
                >
                  <option value="not_reviewed">Ù„Ù… ØªØªØ±Ø§Ø¬Ø¹</option>
                  <option value="reviewed">Ø§ØªØ±Ø§Ø¬Ø¹Øª</option>
                  <option value="in_progress">Ø¨ØªØªÙ†ÙØ°</option>
                  <option value="completed">ØªÙ…Øª</option>
                </select>
              </div>

              {/* Admin Notes */}
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">
                  Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                </label>
                <textarea
                  value={editNotes}
                  onChange={(e) => setEditNotes(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-gold focus:outline-none resize-none"
                  rows={4}
                  placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØªØ­Ø¯ÙŠØ«Ø§Øª..."
                />
              </div>

              {/* Action Buttons */}
              <div className="flex gap-4 pt-4">
                <button
                  onClick={handleUpdateComplaint}
                  className="flex-1 bg-gold hover:bg-gold-dark text-white font-bold py-3 px-6 rounded-xl transition-all duration-200 shadow-lg"
                >
                  Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                </button>
                <button
                  onClick={() => setShowEditModal(false)}
                  className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl transition-all duration-200"
                >
                  Ø¥Ù„ØºØ§Ø¡
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
        </div>
      </div>
    </div>
  )
}
